// Generated by CoffeeScript 1.9.3
var URL_COMPONENTS, isUrlValid, makeFormId, makeTableClass;

URL_COMPONENTS = ['url', 'type', 'headers', 'data'];

makeFormId = function(urlComponent, prependSymbol) {
  var prefix;
  prefix = prependSymbol ? '#' : '';
  return prefix + urlComponent;
};

makeTableClass = function(urlComponent, prependSymbol) {
  var prefix;
  prefix = prependSymbol ? '.' : '';
  return prefix + urlComponent + 'TableCell';
};

$(document).ready(function() {
  $('#type').change(function() {
    var type;
    type = $(this).val();
    if (type === 'GET') {
      return $('#dataWrapper').addClass('hide');
    } else if (type === 'POST') {
      return $('#dataWrapper').removeClass('hide');
    }
  });
  $('#newURLButton').click(function() {
    var data, headers, jsonError, type, url;
    event.preventDefault();
    $('.urlAlert').addClass('hide');
    url = $('#url').val();
    if (!isUrlValid(url)) {
      $('#newURLErrorURL').removeClass('hide');
      return;
    }
    type = $('#type').val();
    headers = $('#headers').val();
    data = type === 'GET' ? '' : $('#data').val();
    if (headers) {
      try {
        $.parseJSON(headers);
      } catch (_error) {
        jsonError = _error;
        $('#newURLErrorHeaders').removeClass('hide');
        return;
      }
    }
    data = type === 'GET' ? '' : $('#data').val();
    if (data) {
      try {
        $.parseJSON(data);
      } catch (_error) {
        jsonError = _error;
        $('#newURLErrorData').removeClass('hide');
        return;
      }
    }
    return $.post('/url', $('#newURLForm').serialize()).done(function(newUrlId) {
      var actionCell, buttonGrouper, deleteButton, i, len, row, tableCell, tableCells, updateButton, urlComponent;
      if ($('#rowToDelete').length) {
        $('#rowToDelete').remove();
        $('#updateURLSuccess').removeClass('hide');
      } else {
        $('#newURLSuccess').removeClass('hide');
      }
      tableCells = [];
      for (i = 0, len = URL_COMPONENTS.length; i < len; i++) {
        urlComponent = URL_COMPONENTS[i];
        tableCell = document.createElement('td');
        $(tableCell).addClass(makeTableClass(urlComponent));
        $(tableCell).append($(makeFormId(urlComponent, true)).val());
        tableCells.push(tableCell);
      }
      updateButton = document.createElement('button');
      $(updateButton).attr({
        'type': 'button',
        'class': 'btn btn-default updateUrl'
      });
      $(updateButton).html('Update');
      deleteButton = document.createElement('button');
      $(deleteButton).attr({
        'type': 'button',
        'class': 'btn btn-default deleteUrl'
      });
      $(deleteButton).html('Delete');
      buttonGrouper = document.createElement('div');
      $(buttonGrouper).attr({
        'class': 'btn-group',
        'role': 'group'
      });
      $(buttonGrouper).append(updateButton, deleteButton);
      actionCell = document.createElement('td');
      $(actionCell).append(buttonGrouper);
      row = document.createElement('tr');
      $(row).attr({
        'data-url-id': newUrlId
      });
      $(row).append(tableCells, actionCell);
      return $('#urlTableBody').prepend(row);
    }).fail(function(requestError) {
      return $("#" + requestError['responseText']).removeClass('hide');
    });
  });
  $('body').delegate('.updateUrl', 'click', function() {
    var _id, cellText, formField, i, len, rowDom, type, urlComponent;
    $('.urlAlert').addClass('hide');
    rowDom = $(this).closest('tr');
    rowDom.attr('id', 'rowToDelete');
    for (i = 0, len = URL_COMPONENTS.length; i < len; i++) {
      urlComponent = URL_COMPONENTS[i];
      formField = $(makeFormId(urlComponent, true));
      cellText = $(rowDom.find(makeTableClass(urlComponent, true))[0]).text();
      formField.val(cellText);
    }
    _id = rowDom.data('url-id');
    $(makeFormId('_id', true)).val(_id);
    type = $(rowDom.find('.typeTableCell')[0]).text();
    if (type === 'GET') {
      $('#dataWrapper').addClass('hide');
    } else if (type === 'POST') {
      $('#dataWrapper').removeClass('hide');
    }
    return window.scrollTo(0, $('#newURLForm').offset());
  });
  return $('body').delegate('.deleteUrl', 'click', function() {
    var _id, rowDom;
    $('.urlAlert').addClass('hide');
    rowDom = $(this).closest('tr');
    _id = rowDom.data('url-id');
    rowDom = $(this).closest('tr');
    return $.ajax({
      url: '/url',
      type: 'DELETE',
      data: {
        _id: _id
      }
    }).done(function() {
      return rowDom.remove();
    }).fail(function() {
      return $('#deleteUrlError').removeClass('hide');
    });
  });
});

isUrlValid = function(url) {
  return /^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url);
};
